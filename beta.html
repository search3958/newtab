<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Newtab v6 Beta</title>
<style>
    :root{
      --iconbg:#fff9;
      --glass-shadow: #fffb 0px 1.5px 3px inset,#fff7 0px -1.5px 3px inset;
      --text-color:#000;
      --bound:linear(0, 0.007 0.7%, 0.031 1.5%, 0.131 3.3%, 0.691 9.9%, 0.904 13%, 1.042 16.1%, 1.087 17.8%, 1.113 19.5%, 1.123 21.5%, 1.117 23.7%, 1.015 34.3%, 0.996 37.6%, 0.986 41.1%, 1.002 62.1%, 1);
      
      /* â˜… å£ç´™ãƒ­ã‚¸ãƒƒã‚¯ç”¨ã«è¿½åŠ ã™ã‚‹CSSå¤‰æ•° */
      --user-wallpaper-light: url('bgimg/material3d1.webp'); /* åˆæœŸãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ */
      --user-wallpaper-dark: url('bgimg/material3d1.webp'); /* åˆæœŸãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ */
    }
    body {
      margin: 0;
      /* ã“ã“ã¯åˆæœŸãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ã‚’æ®‹ã™ã‹ã€èƒŒæ™¯è¦ç´ ã§åˆ¶å¾¡ã—ã¾ã™ */
      /* IndexedDBã‹ã‚‰èª­ã¿è¾¼ã¾ã‚ŒãŸå£ç´™ã‚’é©ç”¨ã™ã‚‹ãŸã‚ã«ä¿®æ­£ */
      background: none; 
      overflow:hidden;
    }
    
    /* â˜… IndexedDBã‹ã‚‰ã®å£ç´™ã‚’é©ç”¨ã™ã‚‹CSSãƒ­ã‚¸ãƒƒã‚¯ (body::beforeã‚’ä½¿ã†ã‹ã€ã¾ãŸã¯ body ã® background-imageã‚’ä¸Šæ›¸ã) */
    body {
        /* ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã¯ãƒ©ã‚¤ãƒˆãƒ¢ãƒ¼ãƒ‰ã®å£ç´™ã‚’ä½¿ç”¨ */
        background-image: var(--user-wallpaper-light);
        background-repeat: no-repeat;
        background-position: center center;
        background-size: cover;
        background-attachment: fixed;
        transition: background-image 0.5s ease;
    }

    /* ã‚·ã‚¹ãƒ†ãƒ ãŒãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰ã‚’è¦æ±‚ã—ã€ã‹ã¤ãƒ€ãƒ¼ã‚¯å£ç´™ãŒè¨­å®šã•ã‚Œã¦ã„ã‚‹å ´åˆã«ä¸Šæ›¸ã */
    @media (prefers-color-scheme: dark) {
        body {
            /* ãƒ€ãƒ¼ã‚¯å£ç´™ãŒè¨­å®šã•ã‚Œã¦ã„ã‚Œã°ãã‚Œã‚’é©ç”¨ */
            background-image: var(--user-wallpaper-dark);
        }
    }


    * { 
      scrollbar-width: none;
    line-height: 1.5!important;
    font-family:
  "Yu Gothic UI",
  "Yu Gothic",
  "Hiragino Sans",
  "Hiragino Kaku Gothic ProN",
  "Meiryo",
  "Noto Sans JP",
  sans-serif;
      -webkit-font-smoothing: antialiased; -moz-osx-font-smoothing: grayscale;
          text-wrap-mode: nowrap;
          user-select: none;

     }
    /* ... æ—¢å­˜ã®CSSãƒ«ãƒ¼ãƒ«ã®ç¶šã ... */
    *::-webkit-scrollbar { display: none; }
    .first{
      
    position: fixed;
    top: calc(50% - 56px);
    left: 50%;
    transform: translate(-50%, -50px);
    display:flex;
    gap:16px;
    }
    .search{
      width:fit-content;
      position:relative;
      border-radius:35px;
      scale:1;
      transition:scale 0.3s cubic-bezier(.34,.24,.18,1);
    }
    .search:active{
      scale:1.03;
    }
    .search-in{
      position:relative;
      z-index:1001;
      background:#fff8;
      padding:13px;
      corner-shape: superellipse(2.4);
      border-radius:90px;
      backdrop-filter:blur(4px) brightness(1.15);
      transition:backdrop-filter 0.3s cubic-bezier(.34,.24,.18,1);
      overflow:hidden;
      --md-ripple-hover-color:#fff0;
      --md-ripple-pressed-color:#fff2;
      --md-ripple-pressed-opacity:1;
    }

    .search-in:active{
      backdrop-filter:blur(4px) brightness(1.3);
    }
    .search-rp{
      border-radius:0px;
    }
    
    .search-input,.search-button{
      background:none;
      outline:none;
      border:none;
      color:var(--text-color);
      font-size:16px;
    }
    .search-input{
      width:155px;
      transition:width 1s var(--bound);
    }
    .search-box{
      padding:16px;
      background:#fff7;
      corner-shape: superellipse(1.6);
      border-radius:29px;
      border:#fff6 1px solid;
      display:flex;
    }
    .control-button{
      padding:16px;
      background:#fff7;
      corner-shape: superellipse(1.6);
      border-radius:14px;
      border:#fff6 1px solid;
      width:100%;
      transition:all 0.3s cubic-bezier(.34,.24,.18,1);
    }
    .control-button:first-child{
      border-radius:29px 14px 14px 29px;
    }
    .control-button:last-child{
      border-radius:14px 29px 29px 14px;
    }
    .control-button.active{
      corner-shape: superellipse(1.04);
      border-radius:29.5px;

    }
    .search-control{
      margin-top:8px;
      display:flex;
      gap:6px;
    }
    svg{
      margin-bottom:-5px;
    }



    .applist{
      width:fit-content;
      position:relative;
      border-radius:35px;
      scale:1;
      transition:scale 0.6s linear(0, 0.379 5.6%, 0.66 11.7%, 0.855 18.5%, 0.924 22.3%, 0.976 26.4%, 1.021 33%, 1.037 41.1%, 1.005 72.8%, 1),box-shadow 0.3s cubic-bezier(.34,.24,.18,1);
      box-shadow:#0002 0px 0px 0px;
    }
    .applist:hover{
      scale:1.3;
      box-shadow:#0002 0px 8px 16px;
    }
    .applist:active{
      scale:1.35;
    }
    .applist-in{
      position:relative;
      z-index:1001;
      background:#fff8;
      padding:13px 0px;
      corner-shape: superellipse(2.4);
      border-radius:90px;
      backdrop-filter:blur(4px) brightness(1.15);
      transition:backdrop-filter 0.3s cubic-bezier(.34,.24,.18,1);
      overflow:scroll;
      --md-ripple-hover-color:#fff0;
      --md-ripple-pressed-color:#fff3;
      --md-ripple-pressed-opacity:1;
      height:calc(100% - 13*2px);
      width:202px;
      height:128px;
    }

    .applist-in:active{
      backdrop-filter:blur(4px) brightness(1.3);
    }




    .category {
      margin-bottom: 8px;
      gap: 8px;
      display: flex;
      justify-content: center;
      flex-wrap: wrap;
      flex-direction: row;
      max-width:875px;
    
}
    .category-title { font-size: 16px; font-weight: 400; margin:0px;margin-bottom: 3px; width:100%; text-align:center;}




    .appicon-bg {
      display: block;
      padding: 0px;
      border-radius: 800px;
      text-align: center;
      width: 100px;
      position:relative;
      height:40px;
      width:40px;
        }
    .appicon-img {
      height:40px;
      width:40px;
      object-fit: cover;
    }
    .appicon-label {
      font-size: 12px;
      margin-top: 4px;
      position:absolute;
      top:20px;
      left:-10px;
      backdrop-filter: brightness(100%);
      padding:6px;
      background:#fff0;
      border-radius:100px;
      corner-shape: squircle;
      scale:0.5;
      color:#0000;
      transition:all 0.3s cubic-bezier(.34,.24,0,1);
      max-width: 75px;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
      opacity:0;
      pointer-events:none;
      z-index:10;
      box-shadow:#0002 0px 8px 16px;
    }
    
    .appicon-bg:hover>.appicon-label {
      top:40px;
      backdrop-filter: brightness(160%) blur(8px);
      background:#fff9;
      scale:0.8;
      color:#000f;
      opacity:1;
      transition-delay:0.5s;
    }


    @media screen and (min-width: 700px) {
      .search-input {
          width: 200px;
      }
    }
    @media screen and (min-width: 1100px) {
      .search-input {
          width: 250px;
      }
    }
    @media screen and (max-width: 515px) {
      .first{

    flex-direction: column;
    align-items: center;
      }
    }
  </style>
</head>
<body>

<div id="history-dialog" style="display:none;position:fixed;z-index:2000;left:0;top:0;width:100vw;height:100vh;background:#0005;backdrop-filter:blur(2px);align-items:center;justify-content:center;">
  <div style="background:#fff;border-radius:16px;padding:24px;min-width:240px;max-width:90vw;box-shadow:0 4px 24px #0003;">
    <h3 style="margin-top:0;">æ¤œç´¢å±¥æ­´</h3>
    <ul id="history-list" style="list-style:none;padding:0;margin:0 0 16px 0;"></ul>
    <button onclick="document.getElementById('history-dialog').style.display='none'">é–‰ã˜ã‚‹</button>
  </div>
</div>

<div id="settings-dialog" style="display:none;position:fixed;z-index:2000;left:0;top:0;width:100vw;height:100vh;background:#0005;backdrop-filter:blur(2px);align-items:center;justify-content:center;">
  <div style="background:#fff;border-radius:16px;padding:24px;min-width:240px;max-width:90vw;box-shadow:0 4px 24px #0003;">
    <h3 style="margin-top:0;">è¨­å®š</h3>
    <div style="margin-bottom:12px;">
      <label>å£ç´™ã‚’é¸æŠ: (å£ç´™ã¯<a href="wallpapers.html" target="_blank">åˆ¥ãƒšãƒ¼ã‚¸</a>ã§è¨­å®šã—ã¦ãã ã•ã„)</label>
    </div>
    <div style="margin-bottom:12px;">
      <button id="clear-history">æ¤œç´¢å±¥æ­´ã‚’å‰Šé™¤</button>
    </div>
    <button onclick="document.getElementById('settings-dialog').style.display='none'">é–‰ã˜ã‚‹</button>
  </div>
</div>

  <script src="https://unpkg.com/fflate@0.8.2/umd/index.js"></script>

<div class="first">
  <div class="search liquid-glass">
    <div class="search-in">
      <md-ripple class="search-rp"></md-ripple>
      <div class="search-box">
        <input class="search-input" placeholder="æ¤œç´¢ã‚„è¨ˆç®—ãƒ»è³ªå•">
        <button class="search-button">æ¤œç´¢</button>
      </div>
      <div class="search-control">
        <button id="" class="control-button">
          <svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 -960 960 960" width="24px" fill="var(--text-color)"><path d="M710-150q-63 0-106.5-43.5T560-300q0-63 43.5-106.5T710-450q63 0 106.5 43.5T860-300q0 63-43.5 106.5T710-150Zm0-80q29 0 49.5-20.5T780-300q0-29-20.5-49.5T710-370q-29 0-49.5 20.5T640-300q0 29 20.5 49.5T710-230Zm-550-30v-80h320v80H160Zm90-250q-63 0-106.5-43.5T100-660q0-63 43.5-106.5T250-810q63 0 106.5 43.5T400-660q0 63-43.5 106.5T250-510Zm0-80q29 0 49.5-20.5T320-660q0-29-20.5-49.5T250-730q-29 0-49.5 20.5T180-660q0 29 20.5 49.5T250-590Zm230-30v-80h320v80H480Zm230 320ZM250-660Z"/></svg>
        </button>
        <button id="" class="control-button">
          <svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 -960 960 960" width="24px" fill="var(--text-color)"><path d="M320-160h320v-120q0-66-47-113t-113-47q-66 0-113 47t-47 113v120Zm160-360q66 0 113-47t47-113v-120H320v120q0 66 47 113t113 47ZM160-80v-80h80v-120q0-61 28.5-114.5T348-480q-51-32-79.5-85.5T240-680v-120h-80v-80h640v80h-80v120q0 61-28.5 114.5T612-480q51 32 79.5 85.5T720-280v120h80v80H160Zm320-80Zm0-640Z"/></svg>
        </button>
        <button id="" class="control-button">
          <svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 -960 960 960" width="24px" fill="var(--text-color)"><path d="M331-651 211-771l57-57 120 120-57 57Zm149-95v-170h80v170h-80Zm291 535L651-331l57-57 120 120-57 57Zm-63-440-57-57 120-120 57 57-120 120Zm38 171v-80h170v80H746ZM205-92 92-205q-12-12-12-28t12-28l363-364q35-35 85-35t85 35q35 35 35 85t-35 85L261-92q-12 12-28 12t-28-12Zm279-335-14.5-14-14.5-14-14-14-14-14 28 28 29 28ZM233-176l251-251-57-56-250 250 56 57Z"/></svg>
        </button>
      </div>
    </div>
  </div>


  <div class="applist liquid-glass">
    <div class="applist-in">
      <md-ripple class="search-rp"></md-ripple>
    </div>
  </div>
</div>


</body>
<script>
// =================================================================
// 1. IndexedDB ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°ã®å®šç¾©
// =================================================================
const DB_NAME = 'WallpaperDB';
const STORE_NAME = 'images';
const DB_VERSION = 1;

function openDB() {
    return new Promise((resolve, reject) => {
        const request = indexedDB.open(DB_NAME, DB_VERSION);

        request.onupgradeneeded = (event) => {
            const db = event.target.result;
            if (!db.objectStoreNames.contains(STORE_NAME)) {
                db.createObjectStore(STORE_NAME);
            }
        };

        request.onsuccess = (event) => {
            resolve(event.target.result);
        };

        request.onerror = (event) => {
            console.error("IndexedDB open error:", event.target.errorCode);
            reject('INDEXEDDB_ERROR');
        };
    });
}

/**
 * IndexedDBã‹ã‚‰æŒ‡å®šã•ã‚ŒãŸã‚­ãƒ¼ã®ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ã™ã‚‹
 * @param {string} key - å–å¾—ã—ãŸã„ãƒ‡ãƒ¼ã‚¿ã®ã‚­ãƒ¼ ('newtab', 'light', 'dark'ã®ã„ãšã‚Œã‹)
 * @returns {Promise<Object | undefined>} - ã‚­ãƒ¼ã«å¯¾å¿œã™ã‚‹ãƒ‡ãƒ¼ã‚¿ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ (light/dark Blob)
 */
async function getFromIndexedDB(key) {
    let db;
    try {
        db = await openDB();
    } catch (e) {
        console.error('DBæ¥ç¶šå¤±æ•—:', e);
        return;
    }

    return new Promise((resolve) => {
        const transaction = db.transaction([STORE_NAME], 'readonly');
        const store = transaction.objectStore(STORE_NAME);
        const request = store.get(key);

        request.onsuccess = (event) => {
            // ä¾‹: { light: Blob, dark: Blob } ã®å½¢å¼ã§è¿”ã•ã‚Œã‚‹
            resolve(event.target.result); 
        };

        request.onerror = (event) => {
            console.error(`IndexedDBã‹ã‚‰ã® ${key} å–å¾—ã‚¨ãƒ©ãƒ¼:`, event.target.error);
            resolve(undefined); // ã‚¨ãƒ©ãƒ¼æ™‚ã¯ undefined ã‚’è¿”ã™
        };
    });
}

// =================================================================
// 2. å£ç´™é©ç”¨ãƒ­ã‚¸ãƒƒã‚¯é–¢æ•°ã®å®šç¾©
// =================================================================

/**
 * Blobãƒ‡ãƒ¼ã‚¿ã‚’CSSå¤‰æ•°ã¨ã—ã¦è¨­å®šã—ã€å£ç´™ã‚’é©ç”¨ã™ã‚‹
 * @param {Blob | null} lightBlob - ãƒ©ã‚¤ãƒˆãƒ¢ãƒ¼ãƒ‰ç”¨ã®Blob (å¿…é ˆ)
 * @param {Blob | null} darkBlob - ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰ç”¨ã®Blob (çœç•¥å¯)
 */
function applyWallpaper(lightBlob, darkBlob = null) {
    // æ—¢å­˜ã®URLãŒã‚ã‚Œã°è§£æ”¾ (ãƒ¡ãƒ¢ãƒªãƒªãƒ¼ã‚¯é˜²æ­¢)
    const existingLightUrl = document.body.dataset.lightUrl;
    const existingDarkUrl = document.body.dataset.darkUrl;
    
    if (existingLightUrl) URL.revokeObjectURL(existingLightUrl);
    if (existingDarkUrl) URL.revokeObjectURL(existingDarkUrl);
    
    delete document.body.dataset.lightUrl;
    delete document.body.dataset.darkUrl;

    // 1. ãƒ©ã‚¤ãƒˆãƒ¢ãƒ¼ãƒ‰ç”¨å£ç´™ã®è¨­å®š
    if (lightBlob) {
        const lightUrl = URL.createObjectURL(lightBlob);
        document.body.style.setProperty('--user-wallpaper-light', `url('${lightUrl}')`);
        document.body.dataset.lightUrl = lightUrl; // è§£æ”¾ç”¨ã«URLã‚’ä¿æŒ
    } else {
        // è¨­å®šãŒãªã„å ´åˆã¯ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ã®CSSå¤‰æ•°ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå£ç´™ï¼‰ã‚’ä½¿ç”¨
        document.body.style.setProperty('--user-wallpaper-light', `url('bgimg/material3d1.webp')`); 
    }

    // 2. ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰ç”¨å£ç´™ã®è¨­å®š
    if (darkBlob) {
        const darkUrl = URL.createObjectURL(darkBlob);
        document.body.style.setProperty('--user-wallpaper-dark', `url('${darkUrl}')`);
        document.body.dataset.darkUrl = darkUrl; // è§£æ”¾ç”¨ã«URLã‚’ä¿æŒ
    } else {
        // ãƒ€ãƒ¼ã‚¯è¨­å®šãŒãªã„å ´åˆã¯ãƒ©ã‚¤ãƒˆå£ç´™ã‚’å‚ç…§ã•ã›ã‚‹ (CSSã§å¯¾å¿œ)
        document.body.style.setProperty('--user-wallpaper-dark', `var(--user-wallpaper-light)`); 
    }
    
    console.log(`å£ç´™ã‚’é©ç”¨ã—ã¾ã—ãŸ: Light=${!!lightBlob}, Dark=${!!darkBlob}`);
}


/**
 * èµ·å‹•æ™‚ã¾ãŸã¯è¨­å®šå¤‰æ›´æ™‚ã«ã€IndexedDBã‹ã‚‰å£ç´™ã‚’èª­ã¿è¾¼ã¿é©ç”¨ã™ã‚‹ãƒ¡ã‚¤ãƒ³é–¢æ•°
 */
async function loadAndApplyCurrentWallpaper() {
    // å„ªå…ˆåº¦ 1: Newtabã«è¨­å®šã•ã‚ŒãŸå£ç´™ã®ç¢ºèª
    const newtabData = await getFromIndexedDB('newtab');
    if (newtabData && newtabData.light) {
        // Newtabè¨­å®šãŒæœ€å„ªå…ˆã€‚ãƒ©ã‚¤ãƒˆç”»åƒã¯å¿…é ˆã€‚
        const lightBlob = newtabData.light;
        
        // ãƒ€ãƒ¼ã‚¯ç”»åƒãŒã‚ã‚Œã°ãã‚Œã‚’ä½¿ç”¨ã€‚ãªã‘ã‚Œã°ãƒ©ã‚¤ãƒˆç”»åƒã‚’ãƒ€ãƒ¼ã‚¯ã®ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ã¨ã™ã‚‹ã€‚
        const darkBlob = newtabData.dark || lightBlob;
        
        applyWallpaper(lightBlob, darkBlob);
        return;
    }

    // å„ªå…ˆåº¦ 2 & 3: å€‹åˆ¥ã®ãƒ©ã‚¤ãƒˆ/ãƒ€ãƒ¼ã‚¯è¨­å®šã®ç¢ºèª
    const lightData = await getFromIndexedDB('light');
    const darkData = await getFromIndexedDB('dark');

    const finalLightBlob = lightData ? lightData.light : null;
    const finalDarkBlob = darkData ? darkData.dark : null;
    
    // lightData ã¨ darkData ã‚’çµ„ã¿åˆã‚ã›ã¦é©ç”¨
    // lightãƒ‡ãƒ¼ã‚¿ãŒãªã„å ´åˆã¯ã€darkãƒ‡ãƒ¼ã‚¿ãŒã‚ã£ã¦ã‚‚ãƒ©ã‚¤ãƒˆãƒ†ãƒ¼ãƒæ™‚ã«ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯å£ç´™ãŒè¡¨ç¤ºã•ã‚Œã‚‹ã€‚
    applyWallpaper(finalLightBlob, finalDarkBlob);
}

// =================================================================
// 3. ãƒªãƒ³ã‚¯ã¨ã‚¢ãƒ—ãƒªä¸€è¦§ã®èª­ã¿è¾¼ã¿ (æ—¢å­˜ã‚³ãƒ¼ãƒ‰)
// =================================================================
const getFileName = (path) => path.split('/').pop();

const loadZip = async (url) => {
  try {
    const response = await fetch(url);
    if (!response.ok) throw new Error('ZIP fetch failed');
    const buffer = await response.arrayBuffer();
    const files = fflate.unzipSync(new Uint8Array(buffer));
    
    const imageMap = {};
    const entries = Object.entries(files);
    
    for (let i = 0; i < entries.length; i++) {
      const [path, data] = entries[i];
      const fileName = getFileName(path);
      const blob = new Blob([data.buffer], { type: 'image/webp' });
      imageMap[fileName] = URL.createObjectURL(blob);
      
      if (i % 10 === 0) await new Promise(r => setTimeout(r, 0));
    }
    return imageMap;
  } catch (err) {
    console.error('loadZip error', err);
    return {};
  }
};

const loadData = async () => {
  try {
    const zipUrl = 'https://search3958.github.io/newtab/lsr/icons-4-5.zip  ';
    const imageMap = await loadZip(zipUrl);

    const jsonUrl = 'https://search3958.github.io/newtab/links.json  ';
    const res = await fetch(jsonUrl);
    if (!res.ok) throw new Error('links.json fetch failed');
    const data = await res.json();

    const container = document.querySelector('.applist-in');
    if (!container) {
      console.error('Element with class "applist-in" not found.');
      return;
    }

    (data.categories || []).forEach(category => {
      const categoryDiv = document.createElement('div');
      categoryDiv.className = 'category';

      const title = document.createElement('h2');
      title.className = 'category-title';
      title.textContent = category.title || 'ç„¡é¡Œ';
      categoryDiv.appendChild(title);

      (category.links || []).forEach(link => {
        const a = document.createElement('a');
        a.href = link.url || '#';
        // ğŸŒŸ MODIFICATION: Explicitly set target to _self to ensure same-tab opening
        a.target = '_self'; 

        const iconDiv = document.createElement('div');
        iconDiv.className = 'appicon-bg';
        if (link.bg) iconDiv.style.background = link.bg;

        const img = document.createElement('img');
        img.className = 'appicon-img';
        const src = imageMap[link.icon];
        img.alt = link.name || '';
        img.src = src || link.icon || '';

        const label = document.createElement('div');
        label.className = 'appicon-label';
        label.textContent = link.name || '';

        iconDiv.appendChild(img);
        iconDiv.appendChild(label);
        a.appendChild(iconDiv);
        categoryDiv.appendChild(a);
      });

      container.appendChild(categoryDiv);
    });

    let cachedRect = null;
    let lastScrollY = -1;

    const checkVisibility = () => {
      const currentScrollY = window.scrollY || window.pageYOffset;
      
      if (lastScrollY === currentScrollY && cachedRect) {
        const isVisible = cachedRect.top <= 0;
        container.classList.toggle('visible', isVisible);
        return;
      }
      
      cachedRect = container.getBoundingClientRect();
      lastScrollY = currentScrollY;
      
      const isVisible = cachedRect.top <= 0;
      container.classList.toggle('visible', isVisible);
    };

    window.addEventListener('scroll', checkVisibility);
    checkVisibility();

    if (window.addLinksAdIfNeeded) {
      window.addLinksAdIfNeeded(container);
    }
  } catch (err) {
    console.error('loadData error', err);
  }
};

// =================================================================
// 4. Liquid Glass ã‚¨ãƒ•ã‚§ã‚¯ãƒˆ (æ—¢å­˜ã‚³ãƒ¼ãƒ‰)
// =================================================================
function applyLiquidGlassEffect(container) {
    const outerCount = 10;
    const outerStep = 4;
    const borderThickness = 6;
    
    let masks = container._glassMasks || [];
    
    if (masks.length === 0) {
        const fragment = document.createDocumentFragment();
        for (let i = 0; i < outerCount; i++) {
            const mask = document.createElement('div');
            Object.assign(mask.style, {
                position: 'absolute',
                pointerEvents: 'none',
                zIndex: `${outerCount - i}`,
                border: `${borderThickness}px solid transparent`,
                mask: 'linear-gradient(#fff 0 0) padding-box, linear-gradient(#fff 0 0)',
                maskComposite: 'exclude',
                webkitMask: 'linear-gradient(#fff 0 0) padding-box, linear-gradient(#fff 0 0)',
                webkitMaskComposite: 'xor',
            });
            
            fragment.appendChild(mask);
            masks.push(mask);
        }
        container.appendChild(fragment);
        container._glassMasks = masks;
    }

    let rafId = null;

    const updateLayout = () => {
        const style = window.getComputedStyle(container);
        const width = parseFloat(style.width);
        const height = parseFloat(style.height);
        const baseRadius = parseFloat(style.borderRadius) || 0;

        for (let i = 0; i < outerCount; i++) {
            const mask = masks[i];
            const inset = i * outerStep;
            
            if (width - inset * 2 <= 0 || height - inset * 2 <= 0) {
                mask.style.display = 'none';
                continue;
            }
            
            const normalizedPosition = (outerCount - i) / outerCount;
            const blur = Math.pow(normalizedPosition, 3.5) * 40;
            const currentRadius = Math.max(baseRadius - inset, 0);

            mask.style.display = 'block';
            mask.style.inset = `${inset}px`;
            mask.style.borderRadius = `${currentRadius}px`;
            mask.style.backdropFilter = `blur(${blur}px)`;
            mask.style.webkitBackdropFilter = `blur(${blur}px)`;
        }
        rafId = null;
    };

    const resizeObserver = new ResizeObserver(() => {
        if (!rafId) {
            rafId = requestAnimationFrame(updateLayout);
        }
    });

    resizeObserver.observe(container);
    container._resizeObserver = resizeObserver;
    
    updateLayout();
}

// =================================================================
// 5. å®Ÿè¡Œãƒ­ã‚¸ãƒƒã‚¯ (æ—¢å­˜ã‚³ãƒ¼ãƒ‰ã¨å£ç´™ãƒ­ã‚¸ãƒƒã‚¯ã®çµ±åˆ)
// =================================================================

// Liquid Glass ã‚¨ãƒ•ã‚§ã‚¯ãƒˆã®å®Ÿè¡Œ
document.querySelectorAll('.liquid-glass').forEach(el => {
    applyLiquidGlassEffect(el);
});

// ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³èµ·å‹•æ™‚ã®å‡¦ç†
window.addEventListener('DOMContentLoaded', () => {
    // 1. IndexedDBã‹ã‚‰å£ç´™ã‚’èª­ã¿è¾¼ã¿ã€CSSå¤‰æ•°ã‚’è¨­å®šã—ã¦é©ç”¨
    loadAndApplyCurrentWallpaper();
    
    // 2. ã‚¢ãƒ—ãƒªä¸€è¦§ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿
    loadData();

    // 3. afterload.jsã‚’200msé…å»¶èª­è¾¼
    setTimeout(() => {
        const s = document.createElement('script');
        s.src = 'beta/afterload.js';
        document.body.appendChild(s);
    }, 200);
});
</script>
</html>