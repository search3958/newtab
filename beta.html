<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Newtab v6 Beta</title>
<style>
    :root{
      --iconbg:#fff9;
      --glass-shadow: #fffb 0px 1.5px 3px inset,#fff7 0px -1.5px 3px inset;
      --text-color:#000;
      --bound:linear(0, 0.007 0.7%, 0.031 1.5%, 0.131 3.3%, 0.691 9.9%, 0.904 13%, 1.042 16.1%, 1.087 17.8%, 1.113 19.5%, 1.123 21.5%, 1.117 23.7%, 1.015 34.3%, 0.996 37.6%, 0.986 41.1%, 1.002 62.1%, 1);
      --ease:cubic-bezier(.34,.24,.18,1);
    }
    body {
      margin: 0;
      overflow:hidden;
          -webkit-font-smoothing: antialiased;
    }
    body {
      background-color:#fff;
        /* デフォルトはライトモードの壁紙を使用 */
        background-image: var(--user-wallpaper-light);
        background-repeat: no-repeat;
        background-position: center center;
        background-size: cover;
        background-attachment: fixed;
    }


    * { 
      scrollbar-width: none;
    line-height: 1.5!important;
    font-family:
  "Yu Gothic UI",
  "Yu Gothic",
  "Hiragino Sans",
  "Hiragino Kaku Gothic ProN",
  "Meiryo",
  "Noto Sans JP",
  sans-serif;
      -webkit-font-smoothing: antialiased; -moz-osx-font-smoothing: grayscale;
          text-wrap-mode: nowrap;
          user-select: none;

     }
    /* ... 既存のCSSルールの続き ... */
    *::-webkit-scrollbar { display: none; }
    .first{
      
    position: fixed;
    top: calc(50% - 56px);
    left: 50%;
    transform: translate(-50%, -50px);
    display:flex;
    gap:16px;
    }
    .search{
      width:fit-content;
      position:relative;
      border-radius:35px;
      scale:1;
      transition:scale 0.3s var(--ease);
    }
    .search:active{
      scale:1.03;
    }
    .search-in{
      position:relative;
      z-index:1001;
      background:#fff8;
      padding:13px;
      corner-shape: superellipse(2.4);
      border-radius:90px;
      backdrop-filter:blur(4px) brightness(1.15);
      transition:backdrop-filter 0.3s var(--ease);
      overflow:hidden;
      --md-ripple-hover-color:#fff0;
      --md-ripple-pressed-color:#fff2;
      --md-ripple-pressed-opacity:1;
    }

    .search-in:active{
      backdrop-filter:blur(4px) brightness(1.3);
    }
    .search-rp{
      border-radius:0px;
    }
    
    .search-input,.search-button{
      background:none;
      outline:none;
      border:none;
      color:var(--text-color);
      font-size:16px;
    }
    .search-input{
      width:155px;
      transition:width 1s var(--bound);
      font-family: 'Google Sans', sans-serif;
    }
    .search-box{
      padding:16px;
      background:#fff7;
      corner-shape: superellipse(1.6);
      border-radius:29px;
      border:#fff6 1px solid;
      display:flex;
    }
    .control-button{
      padding:16px;
      background:#fff7;
      corner-shape: superellipse(1.6);
      border-radius:14px;
      border:#fff6 1px solid;
      width:100%;
      transition:all 0.3s var(--ease);
    }
    .control-button:first-child{
      border-radius:29px 14px 14px 29px;
    }
    .control-button:last-child{
      border-radius:14px 29px 29px 14px;
    }
    .control-button.active{
      corner-shape: superellipse(1.04);
      border-radius:29.5px;

    }
    .search-control{
      margin-top:8px;
      display:flex;
      gap:6px;
    }
    svg{
      margin-bottom:-5px;
    }



    .applist{
      width:fit-content;
      position:relative;
      border-radius:35px;
      scale:1;
      transition:scale 0.6s linear(0, 0.379 5.6%, 0.66 11.7%, 0.855 18.5%, 0.924 22.3%, 0.976 26.4%, 1.021 33%, 1.037 41.1%, 1.005 72.8%, 1),box-shadow 0.3s var(--ease);
      box-shadow:#0002 0px 0px 0px;
    }
    .applist:hover{
      scale:1.3;
      box-shadow:#0002 0px 8px 16px;
    }
    .applist:active{
      scale:1.35;
    }

    .intelligence.applist:hover{
      scale:1;
      box-shadow:#0000 0px 0px 0px;
    }
    .intelligence.applist:active{
      scale:1.03;
    }

    .applist-in{
      position:relative;
      z-index:1001;
      background:#fff8;
      padding:13px 0px;
      corner-shape: superellipse(2.4);
      border-radius:90px;
      backdrop-filter:blur(4px) brightness(1.15);
      transition:backdrop-filter 0.3s var(--ease);
      overflow:scroll;
      --md-ripple-hover-color:#fff0;
      --md-ripple-pressed-color:#fff3;
      --md-ripple-pressed-opacity:1;
      height:calc(100% - 13*2px);
      width:202px;
      height:128px;
    }

    .applist-in:active{
      backdrop-filter:blur(4px) brightness(1.3);
    }




    .category {
      margin-bottom: 8px;
      gap: 8px;
      display: flex;
      justify-content: center;
      flex-wrap: wrap;
      flex-direction: row;
      max-width:875px;
      opacity:1;
      transition:opacity 0.2s ease;
    }
    .intelligence .category{
      opacity:0;
      pointer-events:none;
    }
    .category-title { font-size: 16px; font-weight: 400; margin:0px;margin-bottom: 3px; width:100%; text-align:center;}




    .appicon-bg {
      display: block;
      padding: 0px;
      border-radius: 800px;
      text-align: center;
      width: 100px;
      position:relative;
      height:40px;
      width:40px;
        }
    .appicon-img {
      height:40px;
      width:40px;
      object-fit: cover;
    }
    .appicon-label {
      font-size: 12px;
      margin-top: 4px;
      position:absolute;
      top:20px;
      left:-10px;
      backdrop-filter: brightness(100%);
      padding:6px;
      background:#fff0;
      border-radius:100px;
      corner-shape: squircle;
      scale:0.5;
      color:#0000;
      transition:all 0.3s cubic-bezier(.34,.24,0,1);
      max-width: 75px;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
      opacity:0;
      pointer-events:none;
      z-index:10;
      box-shadow:#0002 0px 8px 16px;
    }
    
    .appicon-bg:hover>.appicon-label {
      top:40px;
      backdrop-filter: brightness(160%) blur(8px);
      background:#fff9;
      scale:0.8;
      color:#000f;
      opacity:1;
      transition-delay:0.5s;
    }


    @media screen and (min-width: 700px) {
      .search-input {
          width: 200px;
      }
    }
    @media screen and (min-width: 1100px) {
      .search-input {
          width: 250px;
      }
    }
    @media screen and (max-width: 515px) {
      .first{

    flex-direction: column;
    align-items: center;
      }
    }



    #history-dialog,#settings-dialog {
        position: fixed;
        z-index: 2000;
        left: 0;
        top: 0;
        width: 100vw;
        height: 100vh;
        background: #0005;
        backdrop-filter: blur(0px);
        align-items: center;
        justify-content: center;
        transition:all 0.4s ease;
        opacity:0;
        pointer-events:none;
    }

    #history-dialog.show,#settings-dialog.show {
        background: #0005;
        backdrop-filter: blur(10px);
        align-items: center;
        justify-content: center;
        opacity:1;
        pointer-events:unset;
    }
    .dialog-box {
        scale: 0.8;
        transition: all 0.6s cubic-bezier(.43,0,.24,.69);
        background: #ffffffd9;
        padding: 32px;
        min-width:300px;
          corner-shape: superellipse(1.6);
          border-radius:64px;
    }
    .show .dialog-box{
      scale:1;
        transition: all 0.6s var(--ease);
    }
    h3{
      font-weight:400;
      font-size:2em;
      margin:0px;
      margin-bottom:16px;
    }
    h4{
      font-weight:400;
      font-size:1.2em;
      margin:4px 0px;
        font-family: 'Google Sans', sans-serif;
    }
    .dialog-box button{
      background:#fff;
      color:#000;
      border:none;
      padding:16px 24px;
          corner-shape: superellipse(1.4);
          border-radius:48px;
          margin-bottom:8px;
    }
    #clear-history{
      background:color(display-p3 0.677 0 0.021 / 1)!important;
      color:#fff!important;
    }
    .intelligence-box{
      opacity:0;
      position:absolute;
      top:0;left:0;
      scale:0.7;
      filter:blur(8px);
      transition:all 0.5s ease;
      height:100%;
      width:100%;
      display:flex;
      gap:8px;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    z-index:1002;
    pointer-events:none;
    }
    .intelligence .intelligence-box{
      opacity:1;
      scale:1;
      filter:blur(0px);
    }
    .intelligence-icon{
          corner-shape: superellipse(-1);
          border-radius:99px;
          height:32px;
          width:32px;
          background:#108cdf;
      transition:all 0.5s ease;
    }

    .intelligence-answer{
      font-size:32px;
      transition:all 0.6s cubic-bezier(.27,.07,0,1);
      position:relative;
      top:0;
      color:#000;
      filter:blur(0px);
      scale:1;
      opacity:1;
      font-family: 'Google Sans', sans-serif;
    }
    .intelligence-answer.hide{
      transition:all 0.15s cubic-bezier(.43,0,1,.55);
      top:16px;
      color:#0059ff;
      filter:blur(4px);
      scale:0.7;
      opacity:0;
    }





    /* システムがダークモードを要求し、かつダーク壁紙が設定されている場合に上書き */
    @media (prefers-color-scheme: dark) {
      :root{
         --iconbg:#0009;
      }
        body {
      background-color:#000;
            /* ダーク壁紙が設定されていればそれを適用 */
            background-image: var(--user-wallpaper-dark);

        }

        .applist-in,.search-in{
          background:#0007;
          backdrop-filter: blur(4px) brightness(0.7);
          color:#fff;
        }

        .applist-in:active,.search-in:active{
            backdrop-filter: blur(4px) brightness(0.9);
        }
        .search-box,.control-button{
          background:#0004;
          border: #fff3 1px solid;
        }
        .search-button,svg,.search-input,.dialog-box,.intelligence-answer{
          color:#fff;
          fill:#fff;
        }
        .dialog-box{
          background:#0c0c0cd0;
        }
        .dialog-box button{
          background:#000;
          color:#fff;
        }
      }
  </style>
</head>
<body>

<div id="history-dialog">
  <div class="dialog-box">
    <h3>検索履歴</h3>
    <ul id="history-list" style="list-style:none;padding:0;margin:0 0 16px 0;"></ul>  </div>
</div>

<div id="settings-dialog">
  <div class="dialog-box">
    <h3>設定</h3>

    <h4>壁紙</h4>
    <button onclick="window.location.href='https://search3958.github.io/project/images/2/'">壁紙を選択</button>
    
    <h4>検索履歴</h4>
    <button id="clear-history">検索履歴を削除</button>
    
    <h4>Newtab v6 満血版</h4>
    <p>ご利用いただく場合，利用規約と<br>プライバシーポリシーの方針に同意するものとみなします。</p>
    <button onclick="window.location.href='https://search3958.github.io/'">私について</button>
    <button onclick="window.location.href='https://search3958.github.io/i/newtab/'">設定方法</button>
    <button onclick="window.location.href='https://search3958.github.io/newtab/newtab-simple.html'">簡易版</button>
    <button onclick="window.location.href='https://search3958.github.io/newtab/beta'">Beta</button>

    <h4>重要情報</h4>
    <button onclick="window.location.href='https://search3958.github.io/policies/trems'">利用規約</button>
    <button onclick="window.location.href='https://search3958.github.io/policies/privacy'">プライバシーポリシー</button>
    <button onclick="window.location.href='https://search3958.github.io/entry'">同意を撤回</button>

  </div>
</div>

  <script src="https://unpkg.com/fflate@0.8.2/umd/index.js"></script>

<div class="first">
  <div class="search liquid-glass">
    <div class="search-in">
      <md-ripple class="search-rp"></md-ripple>
      <div class="search-box">
        <input class="search-input" placeholder="検索や計算・アプリ" autocomplete="off">
        <button class="search-button">検索</button>
      </div>
      <div class="search-control">
        <button id="" class="control-button">
          <svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 -960 960 960" width="24px" fill="var(--text-color)"><path d="M710-150q-63 0-106.5-43.5T560-300q0-63 43.5-106.5T710-450q63 0 106.5 43.5T860-300q0 63-43.5 106.5T710-150Zm0-80q29 0 49.5-20.5T780-300q0-29-20.5-49.5T710-370q-29 0-49.5 20.5T640-300q0 29 20.5 49.5T710-230Zm-550-30v-80h320v80H160Zm90-250q-63 0-106.5-43.5T100-660q0-63 43.5-106.5T250-810q63 0 106.5 43.5T400-660q0 63-43.5 106.5T250-510Zm0-80q29 0 49.5-20.5T320-660q0-29-20.5-49.5T250-730q-29 0-49.5 20.5T180-660q0 29 20.5 49.5T250-590Zm230-30v-80h320v80H480Zm230 320ZM250-660Z"/></svg>
        </button>
        <button id="" class="control-button">
          <svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 -960 960 960" width="24px" fill="var(--text-color)"><path d="M320-160h320v-120q0-66-47-113t-113-47q-66 0-113 47t-47 113v120Zm160-360q66 0 113-47t47-113v-120H320v120q0 66 47 113t113 47ZM160-80v-80h80v-120q0-61 28.5-114.5T348-480q-51-32-79.5-85.5T240-680v-120h-80v-80h640v80h-80v120q0 61-28.5 114.5T612-480q51 32 79.5 85.5T720-280v120h80v80H160Zm320-80Zm0-640Z"/></svg>
        </button>
        <button id="" class="control-button">
          <svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 -960 960 960" width="24px" fill="var(--text-color)"><path d="M331-651 211-771l57-57 120 120-57 57Zm149-95v-170h80v170h-80Zm291 535L651-331l57-57 120 120-57 57Zm-63-440-57-57 120-120 57 57-120 120Zm38 171v-80h170v80H746ZM205-92 92-205q-12-12-12-28t12-28l363-364q35-35 85-35t85 35q35 35 35 85t-35 85L261-92q-12 12-28 12t-28-12Zm279-335-14.5-14-14.5-14-14-14-14-14 28 28 29 28ZM233-176l251-251-57-56-250 250 56 57Z"/></svg>
        </button>
      </div>
    </div>
  </div>


  <div class="applist liquid-glass">
    <div class="applist-in">
      <md-ripple class="search-rp"></md-ripple>
    </div>
      <div class="intelligence-box">
        <div class="intelligence-icon"></div>
        <div class="intelligence-answer hide">7.27</div>
      </div>
  </div>
</div>


</body>
<script>
  // ================================================================
// IndexedDB 設定
// ================================================================
const DB_NAME = 'WallpaperDB';
const STORE_NAME = 'images';
const DB_VERSION = 1;

// ================================================================
// IndexedDB open
// ================================================================
function openDB() {
    return new Promise((resolve, reject) => {
        const request = indexedDB.open(DB_NAME, DB_VERSION);

        request.onupgradeneeded = (event) => {
            const db = event.target?.result;
            if (!db) {
                console.error('onupgradeneeded: db が取得できません');
                return;
            }

            if (!db.objectStoreNames.contains(STORE_NAME)) {
                db.createObjectStore(STORE_NAME);
                console.log(`ObjectStore "${STORE_NAME}" を作成しました`);
            }
        };

        request.onsuccess = (event) => {
            const db = event.target?.result;
            if (!db) {
                console.error('onsuccess: db が取得できません');
                reject('DB_NULL');
                return;
            }
            console.log('IndexedDB 接続成功');
            resolve(db);
        };

        request.onerror = (event) => {
            console.error('IndexedDB open error:', event.target?.error);
            reject('INDEXEDDB_ERROR');
        };
    });
}

// ================================================================
// IndexedDB get
// ================================================================
async function getFromIndexedDB(key) {
    let db;
    try {
        db = await openDB();
    } catch (e) {
        console.error('DB接続失敗:', e);
        return undefined;
    }

    return new Promise((resolve) => {
        const transaction = db.transaction([STORE_NAME], 'readonly');
        const store = transaction.objectStore(STORE_NAME);
        const request = store.get(key);

        request.onsuccess = (event) => {
            console.log(`IndexedDB 取得成功: key=${key}`);
            resolve(event.target?.result);
        };

        request.onerror = (event) => {
            console.error(`IndexedDB 取得エラー: key=${key}`, event.target?.error);
            resolve(undefined);
        };
    });
}

// ================================================================
// Wallpaper apply
// ================================================================
function applyWallpaper(lightBlob, darkBlob = null) {
    const body = document.body;
    if (!body) {
        console.error('applyWallpaper: document.body が存在しません');
        return;
    }

    const existingLightUrl = body.dataset.lightUrl;
    const existingDarkUrl = body.dataset.darkUrl;

    if (existingLightUrl) URL.revokeObjectURL(existingLightUrl);
    if (existingDarkUrl) URL.revokeObjectURL(existingDarkUrl);

    delete body.dataset.lightUrl;
    delete body.dataset.darkUrl;

    if (lightBlob) {
        const lightUrl = URL.createObjectURL(lightBlob);
        body.style.setProperty('--user-wallpaper-light', `url('${lightUrl}')`);
        body.dataset.lightUrl = lightUrl;
    } else {
        body.style.setProperty(
            '--user-wallpaper-light',
            `url('bgimg/material3d1.webp')`
        );
    }

    if (darkBlob) {
        const darkUrl = URL.createObjectURL(darkBlob);
        body.style.setProperty('--user-wallpaper-dark', `url('${darkUrl}')`);
        body.dataset.darkUrl = darkUrl;
    } else {
        body.style.setProperty(
            '--user-wallpaper-dark',
            `var(--user-wallpaper-light)`
        );
    }

    console.log(
        `壁紙適用完了 Light=${!!lightBlob} Dark=${!!darkBlob}`
    );
}

// ================================================================
// Wallpaper load main
// ================================================================
async function loadAndApplyCurrentWallpaper() {
    const newtabData = await getFromIndexedDB('newtab');

    if (newtabData && newtabData.light) {
        applyWallpaper(
            newtabData.light,
            newtabData.dark || newtabData.light
        );
        return;
    }

    const lightData = await getFromIndexedDB('light');
    const darkData = await getFromIndexedDB('dark');

    const finalLightBlob = lightData?.light || null;
    const finalDarkBlob = darkData?.dark || null;

    applyWallpaper(finalLightBlob, finalDarkBlob);
}

// ================================================================
// focus utility
// ================================================================
function focusElementBySelector(selector) {
    if (!selector || typeof selector !== 'string') {
        console.error('focusElementBySelector: selector 不正', selector);
        return;
    }

    const el = document.querySelector(selector);
    if (!el) {
        console.warn(`focusElementBySelector: 要素なし (${selector})`);
        return;
    }

    if (typeof el.focus !== 'function') {
        console.warn(`focusElementBySelector: focus 不可 (${selector})`);
        return;
    }

    requestAnimationFrame(() => {
        el.focus({ preventScroll: true });
        console.log(`フォーカス成功: ${selector}`);
    });
}

// ================================================================
// ZIP / link load
// ================================================================
const getFileName = (path) => path.split('/').pop();

const loadZip = async (url) => {
    try {
        const response = await fetch(url);
        if (!response.ok) throw new Error('ZIP fetch failed');

        const buffer = await response.arrayBuffer();
        const files = fflate.unzipSync(new Uint8Array(buffer));
        const imageMap = {};

        const entries = Object.entries(files);
        for (let i = 0; i < entries.length; i++) {
            const [path, data] = entries[i];
            const fileName = getFileName(path);

            const blob = new Blob([data.buffer], { type: 'image/webp' });
            imageMap[fileName] = URL.createObjectURL(blob);

            if (i % 10 === 0) await new Promise(r => setTimeout(r, 0));
        }

        console.log('ZIP 読み込み完了');
        return imageMap;
    } catch (err) {
        console.error('loadZip error', err);
        return {};
    }
};

const loadData = async () => {
    try {
        const zipUrl = 'https://search3958.github.io/newtab/lsr/icons-4-5.zip';
        const jsonUrl = 'https://search3958.github.io/newtab/links.json';

        const imageMap = await loadZip(zipUrl);

        const res = await fetch(jsonUrl);
        if (!res.ok) throw new Error('links.json fetch failed');
        const data = await res.json();

        const container = document.querySelector('.applist-in');
        if (!container) {
            console.error('.applist-in が見つかりません');
            return;
        }

        (data.categories || []).forEach(category => {
            const categoryDiv = document.createElement('div');
            categoryDiv.className = 'category';

            const title = document.createElement('h2');
            title.className = 'category-title';
            title.textContent = category.title || '無題';
            categoryDiv.appendChild(title);

            (category.links || []).forEach(link => {
                const a = document.createElement('a');
                a.href = link.url || '#';
                a.target = '_self';

                const iconDiv = document.createElement('div');
                iconDiv.className = 'appicon-bg';
                if (link.bg) iconDiv.style.background = link.bg;

                const img = document.createElement('img');
                img.className = 'appicon-img';
                img.src = imageMap[link.icon] || link.icon || '';
                img.alt = link.name || '';

                const label = document.createElement('div');
                label.className = 'appicon-label';
                label.textContent = link.name || '';

                iconDiv.appendChild(img);
                iconDiv.appendChild(label);
                a.appendChild(iconDiv);
                categoryDiv.appendChild(a);
            });

            container.appendChild(categoryDiv);
        });

        console.log('アプリ一覧 読み込み完了');
    } catch (err) {
        console.error('loadData error', err);
    }
};

// ================================================================
// DOMContentLoaded
// ================================================================
window.addEventListener('DOMContentLoaded', () => {
    loadAndApplyCurrentWallpaper();
    loadData();

    // ★ 即フォーカス
    focusElementBySelector('.search-input');

    // afterload.js
    setTimeout(() => {
        const s = document.createElement('script');
        if (!s) {
            console.error('script 要素生成失敗');
            return;
        }

        s.src = 'beta/afterload.js';
        document.body.appendChild(s);
        console.log('afterload.js 読み込み');
    }, 200);
});

</script>
</html>