<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Newtab v6 Beta</title>
<!--
  <script type="importmap">
    {
      "imports": {
        "@material/web/": "https://esm.run/@material/web/"
      }
    }
  </script>
  <script type="module">
    import '@material/web/ripple/ripple.js';
    import {styles as typescaleStyles} from '@material/web/typography/md-typescale-styles.js';

    document.adoptedStyleSheets.push(typescaleStyles.styleSheet);
  </script>
-->

  <style>
    :root{
      --iconbg:#fff9;
      --glass-shadow: #fffb 0px 1.5px 3px inset,#fff7 0px -1.5px 3px inset;
      --text-color:#000;
      --bound:linear(0, 0.007 0.7%, 0.031 1.5%, 0.131 3.3%, 0.691 9.9%, 0.904 13%, 1.042 16.1%, 1.087 17.8%, 1.113 19.5%, 1.123 21.5%, 1.117 23.7%, 1.015 34.3%, 0.996 37.6%, 0.986 41.1%, 1.002 62.1%, 1);
    }
    body {
      margin: 0;
      background: url('https://search3958.github.io/newtab/bgimg/bg1.webp') no-repeat center center fixed;
      background-size: cover;
    }


    * { 
      scrollbar-width: none;
    line-height: 1.5!important;
    font-family:
  "Yu Gothic UI",
  "Yu Gothic",
  "Hiragino Sans",
  "Hiragino Kaku Gothic ProN",
  "Meiryo",
  "Noto Sans JP",
  sans-serif;
      -webkit-font-smoothing: antialiased; -moz-osx-font-smoothing: grayscale;
          text-wrap-mode: nowrap;
          user-select: none;

     }
    *::-webkit-scrollbar { display: none; }
    .first{
      
    position: fixed;
    top: calc(50% - 56px);
    left: 50%;
    transform: translate(-50%, -50px);
    display:flex;
    gap:16px;
    }
    .search{
      width:fit-content;
      position:relative;
      border-radius:35px;
      scale:1;
      transition:scale 0.3s cubic-bezier(.34,.24,.18,1);
    }
    .search:active{
      scale:1.03;
    }
    .search-in{
      position:relative;
      z-index:1001;
      background:#fff4;
      padding:13px;
      corner-shape: superellipse(2.4);
      border-radius:90px;
      backdrop-filter:blur(4px) brightness(1.15);
      transition:backdrop-filter 0.3s cubic-bezier(.34,.24,.18,1);
      overflow:hidden;
      --md-ripple-hover-color:#fff0;
      --md-ripple-pressed-color:#fff2;
      --md-ripple-pressed-opacity:1;
    }

    .search-in:active{
      backdrop-filter:blur(4px) brightness(1.2);
    }
    .search-rp{
      border-radius:0px;
    }
    
    .search-input,.search-button{
      background:none;
      outline:none;
      border:none;
      color:var(--text-color);
      font-size:16px;
    }
    .search-input{
      width:155px;
      transition:width 1s var(--bound);
    }
    .search-box{
      padding:16px;
      background:#fff7;
      corner-shape: superellipse(1.6);
      border-radius:29px;
      border:#fff6 1px solid;
      display:flex;
    }
    .control-button{
      padding:16px;
      background:#fff7;
      corner-shape: superellipse(1.6);
      border-radius:14px;
      border:#fff6 1px solid;
      width:100%;
    }
    .control-button:first-child{
      border-radius:29px 14px 14px 29px;
    }
    .control-button:last-child{
      border-radius:14px 29px 29px 14px;
    }
    .search-control{
      margin-top:8px;
      display:flex;
      gap:6px;
    }
    svg{
      margin-bottom:-5px;
    }



    .applist{
      width:fit-content;
      position:relative;
      border-radius:35px;
      scale:1;
      transition:scale 0.6s linear(0, 0.379 5.6%, 0.66 11.7%, 0.855 18.5%, 0.924 22.3%, 0.976 26.4%, 1.021 33%, 1.037 41.1%, 1.005 72.8%, 1),box-shadow 0.3s cubic-bezier(.34,.24,.18,1);
      box-shadow:#0002 0px 0px 0px;
    }
    .applist:hover{
      scale:1.3;
      box-shadow:#0002 0px 8px 16px;
    }
    .applist:active{
      scale:1.35;
    }
    .applist-in{
      position:relative;
      z-index:1001;
      background:#fff4;
      padding:13px 0px;
      corner-shape: superellipse(2.4);
      border-radius:90px;
      backdrop-filter:blur(4px) brightness(1.15);
      transition:backdrop-filter 0.3s cubic-bezier(.34,.24,.18,1);
      overflow:scroll;
      --md-ripple-hover-color:#fff0;
      --md-ripple-pressed-color:#fff3;
      --md-ripple-pressed-opacity:1;
      height:calc(100% - 13*2px);
      width:202px;
      height:128px;
    }

    .applist-in:active{
      backdrop-filter:blur(4px) brightness(1.2);
    }




    .category {
      margin-bottom: 8px;
      gap: 8px;
      display: flex;
      justify-content: center;
      flex-wrap: wrap;
      flex-direction: row;
      max-width:875px;
    
}
    .category-title { font-size: 16px; font-weight: 400; margin:0px;margin-bottom: 3px; width:100%; text-align:center;}




    .appicon-bg {
      display: block;
      padding: 0px;
      border-radius: 800px;
      text-align: center;
      width: 100px;
      position:relative;
      height:40px;
      width:40px;
        }
    .appicon-img {
      height:40px;
      width:40px;
      object-fit: cover;
    }
    .appicon-label {
      font-size: 12px;
      margin-top: 4px;
      position:absolute;
      top:20px;
      left:-10px;
      backdrop-filter: brightness(100%);
      padding:6px;
      background:#fff0;
      border-radius:100px;
      corner-shape: squircle;
      scale:0.5;
      color:#0000;
      transition:all 0.3s cubic-bezier(.34,.24,0,1);
      max-width: 75px;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
      opacity:0;
      pointer-events:none;
      z-index:10;
      box-shadow:#0002 0px 8px 16px;
    }
    
    .appicon-bg:hover>.appicon-label {
      top:40px;
      backdrop-filter: brightness(160%) blur(8px);
      background:#fff9;
      scale:0.8;
      color:#000f;
      opacity:1;
      transition-delay:0.5s;
    }


    @media screen and (min-width: 700px) {
      .search-input {
          width: 200px;
      }
    }
    @media screen and (min-width: 1100px) {
      .search-input {
          width: 250px;
      }
    }
    @media screen and (max-width: 515px) {
      .first{

    flex-direction: column;
    align-items: center;
      }
    }
  </style>
</head>
<body>

  <script src="https://unpkg.com/fflate@0.8.2/umd/index.js"></script>

<div class="first">
  <div class="search liquid-glass">
    <div class="search-in">
      <md-ripple class="search-rp"></md-ripple>
      <div class="search-box">
        <input class="search-input" placeholder="検索や計算・質問">
        <button class="search-button">検索</button>
      </div>
      <div class="search-control">
        <button id="" class="control-button">
          <svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 -960 960 960" width="24px" fill="var(--text-color)"><path d="M710-150q-63 0-106.5-43.5T560-300q0-63 43.5-106.5T710-450q63 0 106.5 43.5T860-300q0 63-43.5 106.5T710-150Zm0-80q29 0 49.5-20.5T780-300q0-29-20.5-49.5T710-370q-29 0-49.5 20.5T640-300q0 29 20.5 49.5T710-230Zm-550-30v-80h320v80H160Zm90-250q-63 0-106.5-43.5T100-660q0-63 43.5-106.5T250-810q63 0 106.5 43.5T400-660q0 63-43.5 106.5T250-510Zm0-80q29 0 49.5-20.5T320-660q0-29-20.5-49.5T250-730q-29 0-49.5 20.5T180-660q0 29 20.5 49.5T250-590Zm230-30v-80h320v80H480Zm230 320ZM250-660Z"/></svg>
        </button>
        <button id="" class="control-button">
          <svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 -960 960 960" width="24px" fill="var(--text-color)"><path d="M320-160h320v-120q0-66-47-113t-113-47q-66 0-113 47t-47 113v120Zm160-360q66 0 113-47t47-113v-120H320v120q0 66 47 113t113 47ZM160-80v-80h80v-120q0-61 28.5-114.5T348-480q-51-32-79.5-85.5T240-680v-120h-80v-80h640v80h-80v120q0 61-28.5 114.5T612-480q51 32 79.5 85.5T720-280v120h80v80H160Zm320-80Zm0-640Z"/></svg>
        </button>
        <button id="" class="control-button">
          <svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 -960 960 960" width="24px" fill="var(--text-color)"><path d="M331-651 211-771l57-57 120 120-57 57Zm149-95v-170h80v170h-80Zm291 535L651-331l57-57 120 120-57 57Zm-63-440-57-57 120-120 57 57-120 120Zm38 171v-80h170v80H746ZM205-92 92-205q-12-12-12-28t12-28l363-364q35-35 85-35t85 35q35 35 35 85t-35 85L261-92q-12 12-28 12t-28-12Zm279-335-14.5-14-14.5-14-14-14-14-14 28 28 29 28ZM233-176l251-251-57-56-250 250 56 57Z"/></svg>
        </button>
      </div>
    </div>
  </div>


  <div class="applist liquid-glass">
    <div class="applist-in">
      <md-ripple class="search-rp"></md-ripple>
    </div>
  </div>
</div>


</body>
<script>
  const getFileName = (path) => path.split('/').pop();

const loadZip = async (url) => {
  try {
    const response = await fetch(url);
    if (!response.ok) throw new Error('ZIP fetch failed');
    const buffer = await response.arrayBuffer();
    const files = fflate.unzipSync(new Uint8Array(buffer));
    
    const imageMap = {};
    const entries = Object.entries(files);
    
    for (let i = 0; i < entries.length; i++) {
      const [path, data] = entries[i];
      const fileName = getFileName(path);
      const blob = new Blob([data.buffer], { type: 'image/webp' });
      imageMap[fileName] = URL.createObjectURL(blob);
      
      if (i % 10 === 0) await new Promise(r => setTimeout(r, 0));
    }
    return imageMap;
  } catch (err) {
    console.error('loadZip error', err);
    return {};
  }
};

const loadData = async () => {
  try {
    const zipUrl = 'https://search3958.github.io/newtab/lsr/icons-4-5.zip  ';
    const imageMap = await loadZip(zipUrl);

    const jsonUrl = 'https://search3958.github.io/newtab/links.json  ';
    const res = await fetch(jsonUrl);
    if (!res.ok) throw new Error('links.json fetch failed');
    const data = await res.json();

    const container = document.querySelector('.applist-in');
    if (!container) {
      console.error('Element with class "applist-in" not found.');
      return;
    }

    (data.categories || []).forEach(category => {
      const categoryDiv = document.createElement('div');
      categoryDiv.className = 'category';

      const title = document.createElement('h2');
      title.className = 'category-title';
      title.textContent = category.title || '無題';
      categoryDiv.appendChild(title);

      (category.links || []).forEach(link => {
        const a = document.createElement('a');
        a.href = link.url || '#';

        const iconDiv = document.createElement('div');
        iconDiv.className = 'appicon-bg';
        if (link.bg) iconDiv.style.background = link.bg;

        const img = document.createElement('img');
        img.className = 'appicon-img';
        const src = imageMap[link.icon];
        img.alt = link.name || '';
        img.src = src || link.icon || '';

        const label = document.createElement('div');
        label.className = 'appicon-label';
        label.textContent = link.name || '';

        iconDiv.appendChild(img);
        iconDiv.appendChild(label);
        a.appendChild(iconDiv);
        categoryDiv.appendChild(a);
      });

      container.appendChild(categoryDiv);
    });

    let cachedRect = null;
    let lastScrollY = -1;

    const checkVisibility = () => {
      const currentScrollY = window.scrollY || window.pageYOffset;
      
      if (lastScrollY === currentScrollY && cachedRect) {
        const isVisible = cachedRect.top <= 0;
        container.classList.toggle('visible', isVisible);
        return;
      }
      
      cachedRect = container.getBoundingClientRect();
      lastScrollY = currentScrollY;
      
      const isVisible = cachedRect.top <= 0;
      container.classList.toggle('visible', isVisible);
    };

    window.addEventListener('scroll', checkVisibility);
    checkVisibility();

    if (window.addLinksAdIfNeeded) {
      window.addLinksAdIfNeeded(container);
    }
  } catch (err) {
    console.error('loadData error', err);
  }
};

loadData();
</script>
<script>
  function applyLiquidGlassEffect(container) {
    const outerCount = 10;
    const outerStep = 4;
    const borderThickness = 6;
    
    // 既存のマスク要素があれば再利用のために取得、なければ配列を初期化
    let masks = container._glassMasks || [];
    
    // 初回実行時のみ要素を作成（DOM生成コストを初回のみにする）
    if (masks.length === 0) {
        const fragment = document.createDocumentFragment();
        for (let i = 0; i < outerCount; i++) {
            const mask = document.createElement('div');
            // 静的なスタイル（変化しないもの）はここで設定
            Object.assign(mask.style, {
                position: 'absolute',
                pointerEvents: 'none',
                zIndex: `${outerCount - i}`,
                // CSS Mask Compositeを使ってSVG無しで「中抜きの枠」を作る（超高速）
                border: `${borderThickness}px solid transparent`,
                mask: 'linear-gradient(#fff 0 0) padding-box, linear-gradient(#fff 0 0)',
                maskComposite: 'exclude',
                webkitMask: 'linear-gradient(#fff 0 0) padding-box, linear-gradient(#fff 0 0)',
                webkitMaskComposite: 'xor', // Chrome/Safari用
            });
            
            fragment.appendChild(mask);
            masks.push(mask);
        }
        container.appendChild(fragment);
        container._glassMasks = masks; // 参照を保存
    }

    // アニメーションフレーム管理用フラグ
    let rafId = null;

    const updateLayout = () => {
        // コンテナの現在のサイズとスタイルを取得
        // getComputedStyleはリフローを誘発するため、ループの外で一回だけ呼ぶ
        const style = window.getComputedStyle(container);
        const width = parseFloat(style.width);
        const height = parseFloat(style.height);
        const baseRadius = parseFloat(style.borderRadius) || 0;

        // ループ処理（DOMの生成・削除は行わず、styleの書き換えのみ行う）
        for (let i = 0; i < outerCount; i++) {
            const mask = masks[i];
            const inset = i * outerStep;
            
            // サイズが小さくなりすぎる場合は隠す
            if (width - inset * 2 <= 0 || height - inset * 2 <= 0) {
                mask.style.display = 'none';
                continue;
            }
            
            const normalizedPosition = (outerCount - i) / outerCount;
            const blur = Math.pow(normalizedPosition, 3.5) * 40;
            const currentRadius = Math.max(baseRadius - inset, 0);

            // transformやopacityなどのGPUプロパティ以外の変更をバッチ処理的に行う
            // 文字列連結のコストを減らすため、必要なプロパティだけ更新
            mask.style.display = 'block';
            mask.style.inset = `${inset}px`; // position:relativeなしでも、親のパディングボックス基準または配置文脈に従う
            mask.style.borderRadius = `${currentRadius}px`;
            mask.style.backdropFilter = `blur(${blur}px)`;
            mask.style.webkitBackdropFilter = `blur(${blur}px)`;
        }
        rafId = null;
    };

    // ResizeObserverの設定
    const resizeObserver = new ResizeObserver(() => {
        // RequestAnimationFrameを使って描画更新をモニタのリフレッシュレートに同期させる
        // これにより無駄な計算（1フレームに複数回の計算）を間引きます
        if (!rafId) {
            rafId = requestAnimationFrame(updateLayout);
        }
    });

    resizeObserver.observe(container);
    container._resizeObserver = resizeObserver;
    
    // 初回描画
    updateLayout();
}

// 実行
document.querySelectorAll('.liquid-glass').forEach(el => {
    applyLiquidGlassEffect(el);
});


</script>
</html>
