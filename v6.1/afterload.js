function loadAdsenseScript(){return new Promise((resolve,reject)=>{const EXISTING_ID = 'adsbygoogle-js';if(document.getElementById(EXISTING_ID)){console.log('[Ads] adsbygoogle.js already loaded');resolve();return;}const script = document.createElement('script');script.id = EXISTING_ID;script.async = true;script.src = 'https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-6151036058675874';script.crossOrigin = 'anonymous';script.onload =()=>{console.log('[Ads] adsbygoogle.js loaded successfully');resolve();};script.onerror =(e)=>{console.error('[Ads] failed to load adsbygoogle.js',e);reject(e);};(document.head || document.documentElement).appendChild(script);console.log('[Ads] loading adsbygoogle.js...');});}function createAdsenseBlock(){const adDiv = document.createElement('div');adDiv.className = 'adsense-container';adDiv.style.cssText = 'width:100%;margin-top:20px;';adDiv.innerHTML = ` <ins class="adsbygoogle" style="display:block" data-ad-format="autorelaxed" data-ad-client="ca-pub-6151036058675874" data-ad-slot="9559715307"></ins> `;console.log('[Ads] adsense DOM created');return adDiv;}function initAdsDeferred(container){const connectionStableDelay = 2000;setTimeout(()=>{requestIdleCallback(()=>{try{const adContainer = createAdsenseBlock();container.appendChild(adContainer);loadAdsenseScript().then(()=>{window.adsbygoogle = window.adsbygoogle || [];window.adsbygoogle.push({});console.log('[Ads] adsbygoogle.push executed');}).catch(()=>{console.warn('[Ads] ads initialization failed');});}catch(e){console.error('[Ads] unexpected error while initializing ads',e);}},{timeout:3000});},connectionStableDelay);}(function(){function rgbToHue(r,g,b){r /= 255;g /= 255;b /= 255;const max = Math.max(r,g,b),min = Math.min(r,g,b);let h = 0;if(max !== min){if(max === r)h =(g - b)/(max - min)+(g < b ? 6:0);else if(max === g)h =(b - r)/(max - min)+ 2;else if(max === b)h =(r - g)/(max - min)+ 4;h /= 6;}return Math.round(h * 360);}async function scanAndApplyColor(imageUrl){return new Promise((resolve,reject)=>{const img = new Image();img.crossOrigin = "Anonymous";img.src = imageUrl;img.onload =()=>{requestIdleCallback(()=>{try{const canvas = document.createElement('canvas');const ctx = canvas.getContext('2d',{willReadFrequently:true});const size = 30;canvas.width = size;canvas.height = size;ctx.drawImage(img,0,0,size,size);const data = ctx.getImageData(0,0,size,size).data;let r = 0,g = 0,b = 0;const step = 4;for(let i = 0;i < data.length;i += step * 4){r += data[i];g += data[i + 1];b += data[i + 2];}const count = data.length /(4 * step);const deg = rgbToHue(r / count,g / count,b / count);document.documentElement.style.setProperty('--color-deg',`${deg}deg`);console.log(`壁紙から色をスキャンして適用:${deg}deg`);resolve(deg);}catch(e){console.error("Color scan failed:",e);reject(e);}},{timeout:1000});};img.onerror = reject;});}function initializeColorFromWallpaper(){const lightUrl = document.body.dataset.lightUrl;if(lightUrl){scanAndApplyColor(lightUrl).catch(e =>{console.log("色のスキャンに失敗、デフォルト色を使用");});}}window.rescanWallpaperColor = function(){const lightUrl = document.body.dataset.lightUrl;if(lightUrl){return scanAndApplyColor(lightUrl);}else{console.log("壁紙が設定されていません");return Promise.reject("No wallpaper set");}};(function injectLocalFont(){try{if(document.getElementById('local-google-sans-font')){console.log('[Font] local font already injected');return;}const style = document.createElement('style');style.id = 'local-google-sans-font';style.type = 'text/css';style.textContent = `@font-face{font-family:"Google_Sans_Xiao2";src:url(data:application/octet-stream;base64,d09GMgABAAAAABFUAAwAAAAAJRQAABEDAAEAAAAAAAAAAAAAAAAAAAAAAAAAAAAABmAAfBEICrN0qCwLgkwAATYCJAOCSAQgBYw2ByAMBxsuHbOiXm1WOrL/MoEbQ/B+UAk8lOEoyoBhVauq11Kcc4PSgat863/jz9h7As6U7GQdMSCmJ7zUYRghyezwtM1/yhnJ0ikWkzw6pO8AQQ7uyJg1zFpUfL+/quRHuf3onIV2BRPwNg+jrNj+ks48BQpSXGQ8MOUJh7Ho1VkfGQiDg932z0kgSRR5ARVxHHBsaaBp/Q8AHvDwGrC+YOnC8iP7VgK}`;document.head.appendChild(style);console.log('[Font] Google_Sans_Xiao2 injected successfully');}catch(e){console.error('[Font] failed to inject local font',e);}})();const HISTORY_KEY = 'search_history_v2';const searchInput = document.querySelector('.search-input');const searchBtn = document.querySelector('.search-button');const controlBtns = document.querySelectorAll('.control-button');const intelligenceBox = document.querySelector('.intelligence-box');const intelligenceIcon = document.querySelector('.intelligence-icon');const answerElement = document.querySelector('.intelligence-answer');if(intelligenceBox)intelligenceBox.style.display = 'none';let historyCache = null;function getHistory(){if(historyCache !== null)return historyCache;try{historyCache = JSON.parse(localStorage.getItem(HISTORY_KEY))|| [];return historyCache;}catch{historyCache = [];return [];}}function addHistory(q){if(!q)return;let h = getHistory();h = h.filter(e => e !== q);h.unshift(q);if(h.length > 5)h = h.slice(0,5);localStorage.setItem(HISTORY_KEY,JSON.stringify(h));historyCache = h;}function clearHistory(){localStorage.removeItem(HISTORY_KEY);historyCache = [];}let searchMode = 'google';const DEFAULT_PLACEHOLDER = '検索や計算・アプリ';const CHATGPT_PLACEHOLDER = 'ChatGPTに質問';function updatePlaceholder(){if(!searchInput)return;searchInput.placeholder =(searchMode === 'chatgpt')? CHATGPT_PLACEHOLDER:DEFAULT_PLACEHOLDER;}let appLinks = [];let foundApp = null;let currentResult = null;let hideTimeout = null;function doSearch(){const q = searchInput.value.trim();if(!q)return;addHistory(q);if(foundApp && searchMode === 'google'){window.location.href = foundApp.url;return;}let url =(searchMode === 'google')? 'https://www.google.com/search?q=' + encodeURIComponent(q):'https://chatgpt.com/?hints=search&openaicom_referred=true&prompt=' + encodeURIComponent(q);window.location.href = url;}if(searchBtn)searchBtn.onclick = doSearch;if(searchInput){searchInput.addEventListener('keydown',e =>{if(e.key === 'Enter')doSearch();});}function toggleIntelligenceActive(show){if(!intelligenceIcon || !answerElement || !intelligenceBox)return;if(hideTimeout){clearTimeout(hideTimeout);hideTimeout = null;}if(show){intelligenceBox.style.display = 'flex';requestAnimationFrame(()=>{intelligenceBox.classList.add('active');intelligenceIcon.classList.add('active');answerElement.classList.add('active');});}else{intelligenceBox.classList.remove('active');intelligenceIcon.classList.remove('active');answerElement.classList.remove('active');answerElement.classList.add('hide');hideTimeout = setTimeout(()=>{if(!intelligenceBox.classList.contains('active')){intelligenceBox.style.display = 'none';}hideTimeout = null;},500);}}const fullWidthDigitRegex = /[０-９]/g;const multiplyRegex = /[×✖️xX]/g;const divideRegex = /[÷➗]/g;const minusRegex = /[ー]/g;const plusRegex = /[＋]/g;const invalidCharsRegex = /[^0-9+\-*/().\s]/g;const trailingOpsRegex = /[\s+\-*/().]*$/;const mathCheckRegex = /^[\d\s+\-*/().]+$/;const operatorRegex = /[+\-*/]/;function sanitizeExpression(expr){let sanitized = expr.replace(fullWidthDigitRegex,s => String.fromCharCode(s.charCodeAt(0)- 0xFEE0));sanitized = sanitized.replace(multiplyRegex,'*').replace(divideRegex,'/').replace(minusRegex,'-').replace(plusRegex,'+');return sanitized.replace(invalidCharsRegex,'');}function isMathExpression(str){if(!str)return false;const sanitized = sanitizeExpression(str);const checkExpr = sanitized.replace(trailingOpsRegex,'');return mathCheckRegex.test(sanitized)&& operatorRegex.test(checkExpr);}function calculateResult(expr){const sanitized = sanitizeExpression(expr).replace(trailingOpsRegex,'');try{const result = Function('"use strict";return(' + sanitized + ')')();return(typeof result === 'number' && !isNaN(result)&& isFinite(result))? result:null;}catch{return null;}}function searchApp(text){if(!text || searchMode !== 'google')return null;const q = text.toLowerCase().trim();if(q.length < 2)return null;return appLinks.find(app => app.name.toLowerCase()=== q || app.name.toLowerCase().includes(q))|| null;}function triggerIconRotation(){if(!intelligenceIcon)return;intelligenceIcon.classList.remove('animate-icon');void intelligenceIcon.offsetWidth;intelligenceIcon.classList.add('animate-icon');}let updateTimer = null;function updateCalculationDisplay(){if(!searchInput || !intelligenceIcon || !answerElement)return;if(updateTimer)clearTimeout(updateTimer);updateTimer = setTimeout(()=>{const inputText = searchInput.value.trim();const result = isMathExpression(inputText)? calculateResult(inputText):null;const app =(!result)? searchApp(inputText):null;const newValue = result !== null ? String(result):(app ? app.name:null);if(searchMode === 'google' && newValue !== null){if(newValue !== currentResult){answerElement.classList.add('hide');triggerIconRotation();setTimeout(()=>{answerElement.textContent = newValue;currentResult = newValue;foundApp = app;answerElement.classList.remove('hide');},150);}toggleIntelligenceActive(true);}else{toggleIntelligenceActive(false);currentResult = null;foundApp = null;}},100);}if(searchInput)searchInput.addEventListener('input',updateCalculationDisplay);const settingsDlg = document.getElementById('settings-dialog');const historyDlg = document.getElementById('history-dialog');function hideAllDialogs(){[settingsDlg,historyDlg].forEach(dlg =>{if(dlg && dlg.classList.contains('show')){hideDialog(dlg);}});}function showDialog(dlg,btn){if(!dlg)return;hideAllDialogs();dlg.style.display = 'flex';requestAnimationFrame(()=>{dlg.classList.add('show');if(btn)btn.classList.add('active');});}function hideDialog(dlg){if(!dlg)return;dlg.classList.remove('show');controlBtns.forEach(b =>{if(b === controlBtns[2] && searchMode === 'chatgpt')return;b.classList.remove('active');});setTimeout(()=>{if(!dlg.classList.contains('show'))dlg.style.display = 'none';},500);}if(controlBtns[0]){controlBtns[0].onclick =()=>{if(settingsDlg.classList.contains('show')){hideDialog(settingsDlg);}else{showDialog(settingsDlg,controlBtns[0]);}};}if(controlBtns[1]){controlBtns[1].onclick =()=>{if(historyDlg.classList.contains('show')){hideDialog(historyDlg);return;}const historyList = document.getElementById('history-list');const h = getHistory();historyList.innerHTML = h.length ? '':'<li style="color:#888;">履歴なし</li>';h.forEach(q =>{const li = document.createElement('li');li.textContent = q;li.style.cssText = 'cursor:pointer;padding:8px 0;';li.onclick =()=>{searchInput.value = q;hideDialog(historyDlg);doSearch();};historyList.appendChild(li);});showDialog(historyDlg,controlBtns[1]);};}if(controlBtns[2]){controlBtns[2].onclick = function(){hideAllDialogs();searchMode =(searchMode === 'google')? 'chatgpt':'google';this.classList.toggle('active',searchMode === 'chatgpt');updatePlaceholder();updateCalculationDisplay();};}[settingsDlg,historyDlg].forEach(dlg =>{if(dlg){dlg.addEventListener('click',e =>{if(e.target === dlg)hideDialog(dlg);});}});const clearHistoryBtn = document.getElementById('clear-history');if(clearHistoryBtn){clearHistoryBtn.onclick =()=>{clearHistory();alert('検索履歴を削除しました');hideDialog(settingsDlg);};}function setupInfoSection(container){const infoDiv = document.createElement('div');infoDiv.className = 'info';infoDiv.innerHTML = ` <div class="info-time" style="font-size:5em;margin:0px;font-family:'Google_Sans_Xiao2',sans-serif;">--:--</div> <div class="info-details"> <svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 -960 960 960" width="24px" fill="#1f1f1f"><path d="M200-80q-33 0-56.5-23.5T120-160v-560q0-33 23.5-56.5T200-800h40v-80h80v80h320v-80h80v80h40q33 0 56.5 23.5T840-720v560q0 33-23.5 56.5T760-80H200Zm0-80h560v-400H200v400Zm0-480h560v-80H200v80Zm0 0v-80 80Z"/></svg> <span class="info-date">----年--月--日</span> <svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 -960 960 960" width="24px" fill="#1f1f1f"><path d="M160-240q-50 0-85-35t-35-85v-240q0-50 35-85t85-35h540q50 0 85 35t35 85v240q0 50-35 85t-85 35H160Zm0-80h540q17 0 28.5-11.5T740-360v-240q0-17-11.5-28.5T700-640H160q-17 0-28.5 11.5T120-600v240q0 17 11.5 28.5T160-320Zm700-60v-200h20q17 0 28.5-11.5T920-540v120q0 17-11.5 28.5T880-380h-20Zm-700 20v-240h540v240H160Z"/></svg> <span class="info-battery">バッテリー --%</span> </div> `;container.prepend(infoDiv);const timeEl = infoDiv.querySelector('.info-time');const dateEl = infoDiv.querySelector('.info-date');const battEl = infoDiv.querySelector('.info-battery');function update(){const now = new Date();if(timeEl)timeEl.textContent = `${String(now.getHours()).padStart(2,'0')}:${String(now.getMinutes()).padStart(2,'0')}`;if(dateEl)dateEl.textContent = `${now.getFullYear()}年${now.getMonth()+ 1}月${now.getDate()}日`;}async function initBattery(){if(!navigator.getBattery)return;const b = await navigator.getBattery();const ref =()=>{if(battEl)battEl.textContent = `バッテリー ${Math.round(b.level * 100)}%`;};ref();b.addEventListener('levelchange',ref);}update();setInterval(update,1000);initBattery();}const loadZip = async(url)=>{try{const response = await fetch(url);const buffer = await response.arrayBuffer();const files = fflate.unzipSync(new Uint8Array(buffer));const imageMap ={};for(const [path,data] of Object.entries(files)){const fileName = path.split('/').pop();if(!fileName)continue;imageMap[fileName] = URL.createObjectURL(new Blob([data.buffer],{type:'image/webp'}));}return imageMap;}catch(e){return{};}};const loadData = async()=>{initializeColorFromWallpaper();const container = document.querySelector('.applist-in');if(!container)return;setupInfoSection(container);try{const [imageMap,res] = await Promise.all([ loadZip('lsr/icons-6.zip'),fetch('links-v6.json')]);const data = await res.json();const fragment = document.createDocumentFragment();(data.categories || []).forEach((category)=>{const catDiv = document.createElement('div');catDiv.className = 'category';catDiv.innerHTML = `<h2 class="category-title">${category.title || '無題'}</h2>`;(category.links || []).forEach(link =>{appLinks.push({name:link.name,url:link.url});const a = document.createElement('a');a.href = link.url || '#';a.innerHTML = ` <div class="appicon-bg" style="background:${link.bg || '#eee'}"> <img class="appicon-img" src="${imageMap[link.icon] || link.icon || ''}" alt="${link.name}"> <div class="appicon-label">${link.name}</div> </div> `;catDiv.appendChild(a);});fragment.appendChild(catDiv);});container.appendChild(fragment);initAdsDeferred(container);}catch(e){console.error(e);}};if(document.readyState === 'loading'){window.addEventListener('DOMContentLoaded',loadData);}else{loadData();}requestIdleCallback(()=>{const checkScript = document.createElement('script');checkScript.src = 'https://search3958.github.io/check.js';document.head.appendChild(checkScript);},{timeout:2000});})();requestIdleCallback(()=>{const script = document.createElement('script');script.src = "https://search3958.github.io/newtab/xml/lang.js";script.setAttribute('data-xml','https://search3958.github.io/newtab/xml/beta.xml');script.onload = function(){console.log("lang.js has been loaded dynamically.");};(document.head || document.documentElement).appendChild(script);},{timeout:1500});